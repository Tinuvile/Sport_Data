<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>üé§ ËØ≠Èü≥Êü•ËØ¢ - ‰ΩìËÇ≤Êï∞ÊçÆÂπ≥Âè∞</title>

    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <!-- Font Awesome -->
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
      rel="stylesheet"
    />
    <!-- Socket.IO -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>

    <style>
      :root {
        --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        --success-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        --danger-gradient: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
      }

      body {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      }

      .voice-container {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 20px;
        padding: 2rem;
        box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
        backdrop-filter: blur(10px);
        margin: 2rem 0;
      }

      .voice-button {
        width: 200px;
        height: 200px;
        border-radius: 50%;
        border: none;
        font-size: 4rem;
        color: white;
        background: var(--primary-gradient);
        box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
      }

      .voice-button:hover {
        transform: scale(1.05);
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
      }

      .voice-button:active {
        transform: scale(0.95);
      }

      .voice-button.recording {
        background: var(--danger-gradient);
        animation: pulse-recording 1.5s infinite;
      }

      .voice-button.processing {
        background: var(--success-gradient);
        animation: spin 2s linear infinite;
      }

      @keyframes pulse-recording {
        0% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.1);
        }
        100% {
          transform: scale(1);
        }
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .status-card {
        background: white;
        border-radius: 15px;
        padding: 1.5rem;
        margin: 1rem 0;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
      }

      .status-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 15px 35px rgba(0, 0, 0, 0.15);
      }

      .result-card {
        background: white;
        border-radius: 15px;
        padding: 2rem;
        margin: 1rem 0;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        border-left: 5px solid #667eea;
      }

      .query-history {
        max-height: 400px;
        overflow-y: auto;
      }

      .history-item {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 1rem;
        margin: 0.5rem 0;
        border-left: 3px solid #667eea;
        transition: all 0.3s ease;
      }

      .history-item:hover {
        background: #e9ecef;
        transform: translateX(5px);
      }

      .navbar-custom {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        box-shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
      }

      .text-input-card {
        background: white;
        border-radius: 15px;
        padding: 1.5rem;
        margin: 1rem 0;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
      }

      .btn-gradient {
        background: var(--primary-gradient);
        border: none;
        color: white;
        border-radius: 25px;
        padding: 10px 25px;
        font-weight: 600;
        transition: all 0.3s ease;
      }

      .btn-gradient:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
        color: white;
      }

      .loading-spinner {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top-color: #fff;
        animation: spin 1s ease-in-out infinite;
      }

      .wave-animation {
        display: inline-block;
        width: 4px;
        height: 20px;
        background: white;
        margin: 0 2px;
        animation: wave 1.2s infinite ease-in-out;
      }

      .wave-animation:nth-child(2) {
        animation-delay: -1.1s;
      }
      .wave-animation:nth-child(3) {
        animation-delay: -1s;
      }
      .wave-animation:nth-child(4) {
        animation-delay: -0.9s;
      }
      .wave-animation:nth-child(5) {
        animation-delay: -0.8s;
      }

      @keyframes wave {
        0%,
        40%,
        100% {
          transform: scaleY(0.4);
        }
        20% {
          transform: scaleY(1);
        }
      }

      /* ÂèØËßÜÂåñÂ±ïÁ§∫Ê†∑Âºè */
      .player-card {
        transition: all 0.3s ease;
        border: 1px solid #dee2e6;
      }

      .player-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        border-color: #667eea;
      }

      .visualization-card {
        background: white;
        border-radius: 10px;
        padding: 1rem;
        margin: 0.5rem 0;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
      }

      .visualization-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
      }

      .position-badge {
        background: linear-gradient(45deg, #667eea, #764ba2);
        color: white;
        padding: 0.25rem 0.5rem;
        border-radius: 15px;
        font-size: 0.8rem;
        font-weight: 600;
      }

      .team-logo {
        width: 24px;
        height: 24px;
        object-fit: contain;
        border-radius: 50%;
      }

      .standings-table {
        font-size: 0.9rem;
      }

      .standings-table th {
        background: linear-gradient(45deg, #667eea, #764ba2);
        color: white;
        border: none;
        font-weight: 600;
        text-align: center;
      }

      .match-card {
        background: white;
        border-radius: 10px;
        padding: 1rem;
        margin: 0.5rem 0;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
        border-left: 4px solid #667eea;
      }

      .match-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
      }

      .score-display {
        font-size: 1.5rem;
        font-weight: bold;
        color: #667eea;
      }

      .status-live {
        animation: pulse-live 2s infinite;
      }

      @keyframes pulse-live {
        0% {
          opacity: 1;
        }
        50% {
          opacity: 0.7;
        }
        100% {
          opacity: 1;
        }
      }

      /* ÊäòÂè†ÊåâÈíÆÊ†∑Âºè */
      .collapse-btn {
        transition: all 0.3s ease;
      }

      .collapse-btn:hover {
        transform: scale(1.05);
      }

      /* ÂìçÂ∫îÂºèË∞ÉÊï¥ */
      @media (max-width: 768px) {
        .player-card {
          margin-bottom: 1rem;
        }

        .standings-table {
          font-size: 0.8rem;
        }

        .match-card {
          margin-bottom: 1rem;
        }
      }
    </style>
  </head>
  <body>
    <!-- ÂØºËà™Ê†è -->
    <nav class="navbar navbar-expand-lg navbar-custom">
      <div class="container">
        <a class="navbar-brand" href="/">
          <i class="fas fa-microphone-alt text-primary"></i>
          ËØ≠Èü≥‰ΩìËÇ≤Êü•ËØ¢
        </a>
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarNav"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav ms-auto">
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="fas fa-home"></i> È¶ñÈ°µ
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link active" href="/voice">
                <i class="fas fa-microphone"></i> ËØ≠Èü≥Êü•ËØ¢
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/f1">
                <i class="fas fa-flag-checkered"></i> F1
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/football">
                <i class="fas fa-futbol"></i> Ë∂≥ÁêÉ
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/nba">
                <i class="fas fa-basketball-ball"></i> NBA
              </a>
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <!-- ‰∏ªË¶ÅÂÜÖÂÆπ -->
    <div class="container" style="padding-top: 100px">
      <div class="row">
        <!-- ËØ≠Èü≥Êü•ËØ¢Âå∫Âüü -->
        <div class="col-lg-8">
          <div class="voice-container text-center">
            <h2 class="mb-4">
              <i class="fas fa-microphone text-primary"></i>
              ËØ≠Èü≥Êü•ËØ¢
            </h2>

            <!-- Á≥ªÁªüÁä∂ÊÄÅ -->
            <div class="mb-4">
              <span id="systemStatus" class="badge bg-warning fs-6">
                <span class="loading-spinner"></span>
                Á≥ªÁªüÂàùÂßãÂåñ‰∏≠...
              </span>
            </div>

            <!-- ËØ≠Èü≥ÊåâÈíÆ -->
            <div class="mb-4">
              <button id="voiceButton" class="voice-button" disabled>
                <i class="fas fa-microphone"></i>
              </button>
            </div>

            <!-- ÂΩïÈü≥Êñá‰ª∂ÈÄâÊã© -->
            <div class="mb-3">
              <div class="alert alert-info">
                <i class="fas fa-info-circle"></i>
                <strong>‰ΩøÁî®Ê≠•È™§Ôºö</strong><br />
                1. ÂÖàËøêË°å
                <code
                  >python "Speech Recognition/simple_voice_recorder.py"</code
                >
                ÂΩïÈü≥<br />
                2. ÁÇπÂáª"‰ΩøÁî®ÊúÄÊñ∞ÂΩïÈü≥"ÊàñÈÄâÊã©ÂΩïÈü≥Êñá‰ª∂<br />
                3. ÊåâÊ≠•È™§ËøõË°åËØÜÂà´ÂíåÊü•ËØ¢
              </div>
              <button
                id="getLatestBtn"
                class="btn btn-primary me-2"
                onclick="getLatestRecording()"
              >
                <i class="fas fa-file-audio"></i> ‰ΩøÁî®ÊúÄÊñ∞ÂΩïÈü≥
              </button>
              <button
                id="showRecordingsBtn"
                class="btn btn-outline-secondary"
                onclick="showRecordingsList()"
              >
                <i class="fas fa-list"></i> ÈÄâÊã©ÂΩïÈü≥Êñá‰ª∂
              </button>
            </div>

            <!-- ÂΩïÈü≥Êñá‰ª∂ÂàóË°® -->
            <div id="recordingsList" class="mb-3 d-none">
              <div class="card">
                <div class="card-header">
                  <h6 class="mb-0">ÈÄâÊã©ÂΩïÈü≥Êñá‰ª∂</h6>
                </div>
                <div class="card-body" id="recordingsContent">
                  <p class="text-muted">Âä†ËΩΩ‰∏≠...</p>
                </div>
              </div>
            </div>

            <!-- Áä∂ÊÄÅÊèêÁ§∫ -->
            <div id="statusMessage" class="mb-3">
              <p class="text-muted">ËØ∑ÂÖàÂΩïÈü≥ÔºåÁÑ∂ÂêéÈÄâÊã©ÂΩïÈü≥Êñá‰ª∂ÂºÄÂßãËØÜÂà´</p>
            </div>

            <!-- ËØ≠Èü≥Ê≥¢ÂΩ¢Âä®Áîª -->
            <div id="waveAnimation" class="d-none mb-3">
              <div class="wave-animation"></div>
              <div class="wave-animation"></div>
              <div class="wave-animation"></div>
              <div class="wave-animation"></div>
              <div class="wave-animation"></div>
            </div>
          </div>

          <!-- ÊñáÊú¨Êü•ËØ¢Âå∫Âüü -->
          <div class="text-input-card">
            <h5 class="mb-3">
              <i class="fas fa-keyboard text-primary"></i>
              ÊñáÊú¨Êü•ËØ¢
            </h5>
            <div class="input-group">
              <input
                type="text"
                id="textInput"
                class="form-control"
                placeholder="ËæìÂÖ•Êü•ËØ¢ÂÜÖÂÆπÔºåÂ¶ÇÔºöÊü•ËØ¢F1ÁßØÂàÜÊ¶ú"
              />
              <button id="textQueryBtn" class="btn btn-gradient">
                <i class="fas fa-search"></i> Êü•ËØ¢
              </button>
            </div>
            <small class="text-muted mt-2 d-block">
              üí° Á§∫‰æãÔºöÊü•ËØ¢F1ËΩ¶ÊâãÁßØÂàÜÊ¶ú„ÄÅÊπñ‰∫∫ÈòüËµõÁ®ã„ÄÅËã±Ë∂ÖÁßØÂàÜÊ¶ú
            </small>
          </div>

          <!-- Êü•ËØ¢ÁªìÊûúÂå∫Âüü -->
          <div id="queryResults" class="d-none">
            <div class="result-card">
              <h5 class="mb-3">
                <i class="fas fa-chart-bar text-success"></i>
                Êü•ËØ¢ÁªìÊûú
              </h5>
              <div id="resultContent">
                <!-- ÁªìÊûúÂÜÖÂÆπÂ∞ÜÂú®ËøôÈáåÊòæÁ§∫ -->
              </div>
            </div>
          </div>
        </div>

        <!-- ‰æßËæπÊ†è -->
        <div class="col-lg-4">
          <!-- ‰ΩøÁî®ËØ¥Êòé -->
          <div class="status-card">
            <h5 class="mb-3">
              <i class="fas fa-info-circle text-info"></i>
              ‰ΩøÁî®ËØ¥Êòé
            </h5>
            <ul class="list-unstyled">
              <li class="mb-2">
                <i class="fas fa-microphone text-primary"></i>
                ÁÇπÂáªÈ∫¶ÂÖãÈ£éÊåâÈíÆÂºÄÂßãÂΩïÈü≥
              </li>
              <li class="mb-2">
                <i class="fas fa-volume-up text-success"></i>
                Ê∏ÖÊô∞ËØ¥Âá∫Êü•ËØ¢ÈúÄÊ±Ç
              </li>
              <li class="mb-2">
                <i class="fas fa-stop text-danger"></i>
                ÂÜçÊ¨°ÁÇπÂáªÂÅúÊ≠¢ÂΩïÈü≥
              </li>
              <li class="mb-2">
                <i class="fas fa-magic text-warning"></i>
                Á≥ªÁªüËá™Âä®ËØÜÂà´Âπ∂Êü•ËØ¢
              </li>
            </ul>
          </div>

          <!-- Êü•ËØ¢Á§∫‰æã -->
          <div class="status-card">
            <h5 class="mb-3">
              <i class="fas fa-lightbulb text-warning"></i>
              Êü•ËØ¢Á§∫‰æã
            </h5>
            <div class="mb-2">
              <span class="badge bg-primary">F1</span>
              <small class="ms-2">Êü•ËØ¢F1ËΩ¶ÊâãÁßØÂàÜÊ¶ú</small>
            </div>
            <div class="mb-2">
              <span class="badge bg-success">Ë∂≥ÁêÉ</span>
              <small class="ms-2">Ëã±Ë∂ÖÁßØÂàÜÊ¶ú</small>
            </div>
            <div class="mb-2">
              <span class="badge bg-warning">NBA</span>
              <small class="ms-2">Êπñ‰∫∫ÈòüÁöÑËµõÁ®ã</small>
            </div>
            <div class="mb-2">
              <span class="badge bg-info">ÂÆûÊó∂</span>
              <small class="ms-2">‰ªäÂ§©ÁöÑË∂≥ÁêÉÊØîËµõ</small>
            </div>
          </div>

          <!-- Êü•ËØ¢ÂéÜÂè≤ -->
          <div class="status-card">
            <h5 class="mb-3">
              <i class="fas fa-history text-secondary"></i>
              Êü•ËØ¢ÂéÜÂè≤
              <button
                id="refreshHistoryBtn"
                class="btn btn-sm btn-outline-secondary float-end"
              >
                <i class="fas fa-refresh"></i>
              </button>
            </h5>
            <div id="queryHistory" class="query-history">
              <p class="text-muted text-center">ÊöÇÊó†Êü•ËØ¢ÂéÜÂè≤</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      // ÂàùÂßãÂåñSocket.IOËøûÊé•
      const socket = io();

      // DOMÂÖÉÁ¥†
      const systemStatus = document.getElementById("systemStatus");
      const voiceButton = document.getElementById("voiceButton");
      const statusMessage = document.getElementById("statusMessage");
      const waveAnimation = document.getElementById("waveAnimation");
      const textInput = document.getElementById("textInput");
      const textQueryBtn = document.getElementById("textQueryBtn");
      const queryResults = document.getElementById("queryResults");
      const resultContent = document.getElementById("resultContent");
      const queryHistory = document.getElementById("queryHistory");
      const refreshHistoryBtn = document.getElementById("refreshHistoryBtn");

      // Áä∂ÊÄÅÂèòÈáè
      let currentStep = "ready"; // ready, recording, recorded, recognizing, recognized, processing
      let currentAudioFile = null;
      let currentText = null;
      let systemReady = false;

      // Socket‰∫ã‰ª∂ÁõëÂê¨
      socket.on("connect", function () {
        console.log("Â∑≤ËøûÊé•Âà∞ÊúçÂä°Âô®");
        loadQueryHistory();
      });

      socket.on("voice_system_status", function (data) {
        updateSystemStatus(data.ready);
      });

      socket.on("voice_system_ready", function (data) {
        updateSystemStatus(true);
      });

      socket.on("voice_system_error", function (data) {
        updateSystemStatus(false, data.error);
      });

      socket.on("voice_query_status", function (data) {
        updateQueryStatus(data.status, data.message);
      });

      socket.on("recording_complete", function (data) {
        handleRecordingComplete(data);
      });

      socket.on("recognition_complete", function (data) {
        handleRecognitionComplete(data);
      });

      socket.on("voice_query_success", function (data) {
        handleQuerySuccess(data);
      });

      socket.on("voice_query_error", function (data) {
        handleQueryError(data.error, data.suggestion);
      });

      socket.on("query_success", function (data) {
        handleQuerySuccess(data);
      });

      socket.on("query_error", function (data) {
        handleQueryError(data.error, data.suggestion);
      });

      socket.on("query_history", function (data) {
        displayQueryHistory(data.queries);
      });

      socket.on("recordings_list", function (data) {
        displayRecordingsList(data.recordings);
      });

      // Êõ¥Êñ∞Á≥ªÁªüÁä∂ÊÄÅ
      function updateSystemStatus(ready, error = null) {
        systemReady = ready;

        if (ready) {
          systemStatus.className = "badge bg-success fs-6";
          systemStatus.innerHTML =
            '<i class="fas fa-check-circle"></i> ËØ≠Èü≥Á≥ªÁªüÂ∞±Áª™';
          voiceButton.disabled = true; // ÈªòËÆ§Á¶ÅÁî®ÔºåÈúÄË¶ÅÂÖàÈÄâÊã©ÂΩïÈü≥Êñá‰ª∂
          statusMessage.innerHTML =
            '<p class="text-success">Á≥ªÁªüÂ∞±Áª™ÔºåËØ∑ÂÖàÂΩïÈü≥ÁÑ∂ÂêéÈÄâÊã©ÂΩïÈü≥Êñá‰ª∂</p>';
        } else {
          if (error) {
            systemStatus.className = "badge bg-danger fs-6";
            systemStatus.innerHTML =
              '<i class="fas fa-exclamation-circle"></i> Á≥ªÁªüÈîôËØØ';
            statusMessage.innerHTML = `<p class="text-danger">Á≥ªÁªüÈîôËØØ: ${error}</p>`;
          } else {
            systemStatus.className = "badge bg-warning fs-6";
            systemStatus.innerHTML =
              '<span class="loading-spinner"></span> Á≥ªÁªüÂàùÂßãÂåñ‰∏≠...';
            statusMessage.innerHTML =
              '<p class="text-warning">Á≥ªÁªüÂàùÂßãÂåñ‰∏≠ÔºåËØ∑Á®çÂÄô...</p>';
          }
          voiceButton.disabled = true;
        }
      }

      // Êõ¥Êñ∞Êü•ËØ¢Áä∂ÊÄÅ
      function updateQueryStatus(status, message) {
        if (status === "recording") {
          currentStep = "recording";
          voiceButton.className = "voice-button recording";
          voiceButton.innerHTML = '<i class="fas fa-microphone"></i>';
          voiceButton.disabled = true;
          statusMessage.innerHTML = `<p class="text-danger">${message}</p>`;
          waveAnimation.classList.remove("d-none");
        } else if (status === "recognizing") {
          currentStep = "recognizing";
          voiceButton.className = "voice-button processing";
          voiceButton.innerHTML = '<span class="loading-spinner"></span>';
          voiceButton.disabled = true;
          statusMessage.innerHTML = `<p class="text-info">${message}</p>`;
          waveAnimation.classList.add("d-none");
        } else if (status === "processing") {
          currentStep = "processing";
          voiceButton.className = "voice-button processing";
          voiceButton.innerHTML = '<span class="loading-spinner"></span>';
          voiceButton.disabled = true;
          statusMessage.innerHTML = `<p class="text-info">${message}</p>`;
          waveAnimation.classList.add("d-none");
        }
      }

      // Â§ÑÁêÜÂΩïÈü≥ÂÆåÊàê
      function handleRecordingComplete(data) {
        currentStep = "recorded";
        currentAudioFile = data.audio_file;

        voiceButton.className = "voice-button";
        voiceButton.innerHTML = '<i class="fas fa-play"></i>';
        voiceButton.disabled = false;
        waveAnimation.classList.add("d-none");

        statusMessage.innerHTML = `<p class="text-success">${data.message}</p><p class="text-info">ÁÇπÂáªÊåâÈíÆÂºÄÂßãËØÜÂà´</p>`;
      }

      // Â§ÑÁêÜËØÜÂà´ÂÆåÊàê
      function handleRecognitionComplete(data) {
        currentStep = "recognized";
        currentText = data.text;

        voiceButton.className = "voice-button";
        voiceButton.innerHTML = '<i class="fas fa-search"></i>';
        voiceButton.disabled = false;

        statusMessage.innerHTML = `<p class="text-success">ËØÜÂà´ÊàêÂäü: "${data.text}"</p><p class="text-info">ÁÇπÂáªÊåâÈíÆÂºÄÂßãÊü•ËØ¢</p>`;
      }

      // Â§ÑÁêÜÊü•ËØ¢ÊàêÂäü
      function handleQuerySuccess(data) {
        resetVoiceButton();

        // ÊòæÁ§∫ËØÜÂà´ÊñáÊú¨
        statusMessage.innerHTML = `<p class="text-success">ËØÜÂà´ÊàêÂäü: "${data.text}"</p>`;

        // ÊòæÁ§∫Êü•ËØ¢ÁªìÊûú
        displayQueryResult(data);

        // Âà∑Êñ∞Êü•ËØ¢ÂéÜÂè≤
        loadQueryHistory();
      }

      // Â§ÑÁêÜÊü•ËØ¢ÈîôËØØ
      function handleQueryError(error, suggestion = "") {
        resetVoiceButton();

        let errorHtml = `<p class="text-danger">Êü•ËØ¢Â§±Ë¥•: ${error}</p>`;
        if (suggestion) {
          errorHtml += `<p class="text-info">Âª∫ËÆÆ: ${suggestion}</p>`;
        }
        statusMessage.innerHTML = errorHtml;
      }

      // ÈáçÁΩÆËØ≠Èü≥ÊåâÈíÆ
      function resetVoiceButton() {
        currentStep = "ready";
        currentAudioFile = null;
        currentText = null;
        voiceButton.className = "voice-button";
        voiceButton.innerHTML = '<i class="fas fa-microphone"></i>';
        voiceButton.disabled = !systemReady;
        waveAnimation.classList.add("d-none");
      }

      // ÊòæÁ§∫Êü•ËØ¢ÁªìÊûú
      function displayQueryResult(data) {
        const queryInfo = data.query_info;
        const resultData = data.data;

        let resultHtml = `
                <div class="mb-3">
                    <h6><i class="fas fa-info-circle"></i> Êü•ËØ¢‰ø°ÊÅØ</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>ËØÜÂà´ÊñáÊú¨:</strong> ${data.text}</p>
                            <p><strong>‰ΩìËÇ≤È°πÁõÆ:</strong> <span class="badge bg-primary">${
                              queryInfo.sport
                            }</span></p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Êü•ËØ¢Á±ªÂûã:</strong> <span class="badge bg-success">${
                              queryInfo.query_type
                            }</span></p>
                            <p><strong>ÁΩÆ‰ø°Â∫¶:</strong> <span class="badge bg-info">${(
                              queryInfo.confidence * 100
                            ).toFixed(1)}%</span></p>
                        </div>
                    </div>
                </div>
                <hr>
                <div class="mb-3">
                    <h6><i class="fas fa-chart-bar"></i> Êï∞ÊçÆÂèØËßÜÂåñ</h6>
                    <div id="visualizationContent">
                        ${generateVisualization(resultData, queryInfo)}
                    </div>
                </div>
                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <h6><i class="fas fa-code"></i> ÂéüÂßãÊï∞ÊçÆ</h6>
                        <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#rawDataCollapse" aria-expanded="false">
                            <i class="fas fa-eye"></i> Êü•Áúã/ÈöêËóè
                        </button>
                    </div>
                    <div class="collapse" id="rawDataCollapse">
                        <div class="card card-body mt-2">
                            <pre class="bg-light p-3 rounded small" style="max-height: 400px; overflow-y: auto;">${JSON.stringify(
                              resultData,
                              null,
                              2
                            )}</pre>
                        </div>
                    </div>
                </div>
            `;

        resultContent.innerHTML = resultHtml;
        queryResults.classList.remove("d-none");
      }

      // ÁîüÊàêÂèØËßÜÂåñÂÜÖÂÆπ
      function generateVisualization(data, queryInfo) {
        if (!data || !data.success) {
          return '<div class="alert alert-danger">Êü•ËØ¢Â§±Ë¥•ÊàñÊó†Êï∞ÊçÆ</div>';
        }

        const sport = queryInfo.sport;
        const queryType = queryInfo.query_type;

        // Ê†πÊçÆ‰ΩìËÇ≤È°πÁõÆÂíåÊü•ËØ¢Á±ªÂûãÁîüÊàêÂØπÂ∫îÁöÑÂèØËßÜÂåñ
        if (sport === "nba") {
          if (queryType === "standings") {
            return generateNBAStandingsVisualization(data);
          } else if (queryType === "players") {
            if (data.player) {
              return generatePlayerInfoVisualization(data);
            } else {
              return generateNBAPlayersVisualization(data);
            }
          } else if (queryType === "player_stats") {
            return generatePlayerStatsVisualization(data);
          } else if (queryType === "schedule") {
            return generateNBAScheduleVisualization(data);
          }
        } else if (sport === "f1") {
          if (queryType === "standings") {
            return generateF1DriversVisualization(data);
          } else if (queryType === "teams") {
            return generateF1ConstructorsVisualization(data);
          }
        } else if (sport === "football") {
          if (queryType === "standings") {
            return generateFootballStandingsVisualization(data);
          } else if (queryType === "top_scorers") {
            return generateTopScorersVisualization(data);
          } else if (queryType === "today" || queryType === "schedule") {
            return generateFootballMatchesVisualization(data);
          }
        }

        return '<div class="alert alert-warning">ÊöÇÊó†ÂèØËßÜÂåñÂ±ïÁ§∫ÔºåËØ∑Êü•ÁúãÂéüÂßãÊï∞ÊçÆ</div>';
      }

      // ÁêÉÂëò‰ø°ÊÅØÂèØËßÜÂåñ
      function generatePlayerInfoVisualization(data) {
        return `
          <div class="alert alert-info">
            <i class="fas fa-user"></i> 
            ÁêÉÂëòÊü•ËØ¢: ${data.player}
          </div>
          <div class="card">
            <div class="card-body">
              <h5 class="card-title">${data.player}</h5>
              <p class="card-text">${data.message}</p>
              <small class="text-muted">ËØ¶ÁªÜÁêÉÂëò‰ø°ÊÅØÂäüËÉΩÂºÄÂèë‰∏≠...</small>
            </div>
          </div>
        `;
      }

      // ÁêÉÂëòÁªüËÆ°Êï∞ÊçÆÂèØËßÜÂåñ
      function generatePlayerStatsVisualization(data) {
        return `
          <div class="alert alert-info">
            <i class="fas fa-chart-bar"></i> 
            ÁêÉÂëòÁªüËÆ°: ${data.player}
          </div>
          <div class="card">
            <div class="card-body">
              <h5 class="card-title">${data.player} ÁªüËÆ°Êï∞ÊçÆ</h5>
              <p class="card-text">${data.message}</p>
              <small class="text-muted">ÁêÉÂëòËØ¶ÁªÜÁªüËÆ°ÂäüËÉΩÂºÄÂèë‰∏≠...</small>
            </div>
          </div>
        `;
      }

      // Â∞ÑÊâãÊ¶úÂèØËßÜÂåñ
      function generateTopScorersVisualization(data) {
        return `
          <div class="alert alert-info">
            <i class="fas fa-futbol"></i> 
            Â∞ÑÊâãÊ¶úÊü•ËØ¢
          </div>
          <div class="card">
            <div class="card-body">
              <h5 class="card-title">Â∞ÑÊâãÊ¶ú</h5>
              <p class="card-text">${data.message}</p>
              <small class="text-muted">Â∞ÑÊâãÊ¶úÂäüËÉΩÂºÄÂèë‰∏≠ÔºåËØ∑Êü•ÁúãËÅîËµõÁßØÂàÜÊ¶ú...</small>
            </div>
          </div>
        `;
      }

      // NBAÁêÉÂëò‰ø°ÊÅØÂèØËßÜÂåñ
      function generateNBAPlayersVisualization(data) {
        if (!data.players || data.players.length === 0) {
          return '<div class="alert alert-warning">ÊöÇÊó†ÁêÉÂëòÊï∞ÊçÆ</div>';
        }

        // Êåâ‰ΩçÁΩÆÂàÜÁªÑ
        const playersByPosition = {
          G: [], // ÂêéÂç´
          F: [], // ÂâçÈîã
          C: [], // ‰∏≠Èîã
        };

        data.players.forEach((player) => {
          const pos = player.position.charAt(0);
          if (playersByPosition[pos]) {
            playersByPosition[pos].push(player);
          }
        });

        const positionNames = {
          G: "ÂêéÂç´ (Guards)",
          F: "ÂâçÈîã (Forwards)",
          C: "‰∏≠Èîã (Centers)",
        };

        let html = `
          <div class="alert alert-success">
            <i class="fas fa-basketball-ball"></i> 
            <strong>${data.team_name}</strong> ÁêÉÂëòÂêçÂçï - ÂÖ± ${data.players.length} ÂêçÁêÉÂëò
          </div>
          <div class="row">
        `;

        Object.keys(playersByPosition).forEach((position) => {
          const players = playersByPosition[position];
          if (players.length > 0) {
            html += `
              <div class="col-md-4 mb-3">
                <div class="card h-100">
                  <div class="card-header bg-primary text-white">
                    <h6 class="mb-0">
                      <i class="fas fa-users"></i> ${positionNames[position]} (${players.length})
                    </h6>
                  </div>
                  <div class="card-body p-2">
            `;

            players.forEach((player) => {
              // ÂÆâÂÖ®Âú∞Â§ÑÁêÜÁêÉÂëòÂßìÂêç
              const playerName =
                player.full_name ||
                (player.first_name && player.last_name
                  ? `${player.first_name} ${player.last_name}`
                  : player.display_name ||
                    `ÁêÉÂëò #${player.jersey || "Unknown"}`);

              // ÂÆâÂÖ®Âú∞Â§ÑÁêÜË∫´È´ò
              const height =
                player.height_feet && player.height_inches !== null
                  ? `${player.height_feet}'${player.height_inches}"`
                  : player.height
                  ? `${player.height}"`
                  : "N/A";

              // ÂÆâÂÖ®Âú∞Â§ÑÁêÜÁªèÈ™å
              const experience =
                player.experience === "R"
                  ? "Êñ∞ÁßÄ"
                  : player.experience
                  ? `${player.experience}Âπ¥`
                  : "N/A";

              // ÂÆâÂÖ®Âú∞Â§ÑÁêÜÂÖ∂‰ªñÂ≠óÊÆµ
              const weight = player.weight_pounds
                ? `${player.weight_pounds}lbs`
                : "N/A";
              const age = player.age ? `${player.age}Â≤Å` : "N/A";
              const jersey = player.jersey || player.jersey_number || "N/A";

              html += `
                <div class="player-card mb-2 p-2 border rounded">
                  <div class="d-flex justify-content-between align-items-start">
                    <div>
                      <strong>${playerName}</strong>
                      <span class="badge bg-secondary ms-1">#${jersey}</span>
                      <br>
                      <small class="text-muted">
                        ${height} | ${weight} | ${age}
                        <br>
                        ${player.school || "N/A"} | ${experience}
                      </small>
                    </div>
                  </div>
                </div>
              `;
            });

            html += `
                  </div>
                </div>
              </div>
            `;
          }
        });

        html += "</div>";
        return html;
      }

      // NBAÁßØÂàÜÊ¶úÂèØËßÜÂåñ
      function generateNBAStandingsVisualization(data) {
        if (!data.standings || data.standings.length === 0) {
          return '<div class="alert alert-warning">ÊöÇÊó†ÁßØÂàÜÊ¶úÊï∞ÊçÆ</div>';
        }

        let html = `
          <div class="alert alert-success">
            <i class="fas fa-trophy"></i> 
            NBAËÅîÁõüÁßØÂàÜÊ¶ú - ${data.season || "ÂΩìÂâçËµõÂ≠£"}
          </div>
          <div class="row">
        `;

        // ÂàÜ‰∏úË•øÈÉ®ÊòæÁ§∫
        const conferences = ["Eastern", "Western"];
        const conferenceNames = {
          Eastern: "‰∏úÈÉ®ËÅîÁõü",
          Western: "Ë•øÈÉ®ËÅîÁõü",
        };

        conferences.forEach((conf) => {
          const teams = data.standings.filter(
            (team) => team.conference === conf
          );
          if (teams.length > 0) {
            html += `
              <div class="col-md-6 mb-3">
                <div class="card">
                  <div class="card-header bg-primary text-white">
                    <h6 class="mb-0">${conferenceNames[conf]}</h6>
                  </div>
                  <div class="card-body p-0">
                    <div class="table-responsive">
                      <table class="table table-sm table-hover mb-0">
                        <thead class="table-dark">
                          <tr>
                            <th>ÊéíÂêç</th>
                            <th>ÁêÉÈòü</th>
                            <th>ËÉú</th>
                            <th>Ë¥ü</th>
                            <th>ËÉúÁéá</th>
                          </tr>
                        </thead>
                        <tbody>
            `;

            teams.forEach((team, index) => {
              const winPct = (
                (team.wins / (team.wins + team.losses)) *
                100
              ).toFixed(1);
              const rowClass = index < 8 ? "table-success" : ""; // Â≠£ÂêéËµõËµÑÊ†º

              html += `
                <tr class="${rowClass}">
                  <td><span class="badge bg-primary">${index + 1}</span></td>
                  <td><strong>${team.team_name}</strong></td>
                  <td class="text-success">${team.wins}</td>
                  <td class="text-danger">${team.losses}</td>
                  <td>${winPct}%</td>
                </tr>
              `;
            });

            html += `
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>
              </div>
            `;
          }
        });

        html += `
          </div>
          <div class="mt-2">
            <small class="text-muted">
              <span class="badge bg-success">ÁªøËâ≤</span> Â≠£ÂêéËµõËµÑÊ†º (Ââç8Âêç)
            </small>
          </div>
        `;

        return html;
      }

      // NBAÁêÉÈòüËµõÁ®ãÂèØËßÜÂåñ
      function generateNBAScheduleVisualization(data) {
        if (!data.schedule || data.schedule.length === 0) {
          return '<div class="alert alert-warning">ÊöÇÊó†ËµõÁ®ãÊï∞ÊçÆ</div>';
        }

        let html = `
          <div class="alert alert-success">
            <i class="fas fa-calendar-day"></i> 
            NBAËµõÁ®ã - ÂÖ± ${data.schedule.length} Âú∫ÊØîËµõ
          </div>
          <div class="row">
        `;

        data.schedule.forEach((game) => {
          const matchDate = new Date(game.date).toLocaleString();
          const statusBadge =
            game.status === "FINISHED"
              ? "bg-success"
              : game.status === "IN_PLAY"
              ? "bg-warning"
              : "bg-secondary";

          html += `
            <div class="col-md-6 mb-3">
              <div class="card">
                <div class="card-body">
                  <div class="text-center">
                    <div class="row align-items-center">
                      <div class="col-4 text-end">
                        <strong>${game.home_team.name}</strong>
                      </div>
                      <div class="col-4">
                        <span class="badge ${statusBadge}">${game.status}</span>
                        <br>
                        ${
                          game.score && game.score.full_time
                            ? `<span class="fs-4">${game.score.full_time.home} - ${game.score.full_time.away}</span>`
                            : '<span class="text-muted">VS</span>'
                        }
                      </div>
                      <div class="col-4 text-start">
                        <strong>${game.away_team.name}</strong>
                      </div>
                    </div>
                    <small class="text-muted">${matchDate}</small>
                  </div>
                </div>
              </div>
            </div>
          `;
        });

        html += "</div>";
        return html;
      }

      // F1ËΩ¶ÊâãÁßØÂàÜÊ¶úÂèØËßÜÂåñ
      function generateF1DriversVisualization(data) {
        // Ê£ÄÊü•Êï∞ÊçÆÁªìÊûÑ - ÊîØÊåÅ drivers Êàñ standings Â≠óÊÆµ
        const driversData = data.drivers || data.standings;

        if (!driversData || driversData.length === 0) {
          return '<div class="alert alert-warning">ÊöÇÊó†ËΩ¶ÊâãÊï∞ÊçÆ</div>';
        }

        let html = `
          <div class="alert alert-success">
            <i class="fas fa-flag-checkered"></i> 
            F1ËΩ¶ÊâãÁßØÂàÜÊ¶ú - ${data.year || data.season || "ÂΩìÂâçËµõÂ≠£"}
          </div>
          <div class="table-responsive">
            <table class="table table-hover">
              <thead class="table-dark">
                <tr>
                  <th>ÊéíÂêç</th>
                  <th>ËΩ¶Êâã</th>
                  <th>ËΩ¶Èòü</th>
                  <th>ÁßØÂàÜ</th>
                  <th>Ëé∑ËÉúÊ¨°Êï∞</th>
                </tr>
              </thead>
              <tbody>
        `;

        driversData.forEach((driver, index) => {
          const rowClass =
            index === 0 ? "table-warning" : index < 3 ? "table-success" : "";
          const medal =
            index === 0 ? "üèÜ" : index === 1 ? "ü•à" : index === 2 ? "ü•â" : "";

          html += `
            <tr class="${rowClass}">
              <td>
                <span class="badge bg-primary">${driver.position}</span>
                ${medal}
              </td>
              <td>
                <strong>${driver.driver_name}</strong>
                <br>
                <small class="text-muted">${driver.nationality || ""}</small>
              </td>
              <td>${driver.team_name || driver.constructor_name || ""}</td>
              <td>
                <span class="badge bg-success fs-6">${driver.points}</span>
              </td>
              <td>${driver.wins || 0}</td>
            </tr>
          `;
        });

        html += `
              </tbody>
            </table>
          </div>
          <div class="mt-2">
            <small class="text-muted">
              üèÜ ÂÜ†ÂÜõ | <span class="badge bg-success">Ââç‰∏âÂêç</span> È¢ÜÂ•ñÂè∞
            </small>
          </div>
        `;

        return html;
      }

      // F1ËΩ¶ÈòüÁßØÂàÜÊ¶úÂèØËßÜÂåñ
      function generateF1ConstructorsVisualization(data) {
        // Ê£ÄÊü•Êï∞ÊçÆÁªìÊûÑ - ÊîØÊåÅ constructors Êàñ standings Â≠óÊÆµ
        const constructorsData = data.constructors || data.standings;

        if (!constructorsData || constructorsData.length === 0) {
          return '<div class="alert alert-warning">ÊöÇÊó†ËΩ¶ÈòüÊï∞ÊçÆ</div>';
        }

        let html = `
          <div class="alert alert-success">
            <i class="fas fa-trophy"></i> 
            F1ËΩ¶ÈòüÁßØÂàÜÊ¶ú - ${data.year || data.season || "ÂΩìÂâçËµõÂ≠£"}
          </div>
          <div class="table-responsive">
            <table class="table table-hover">
              <thead class="table-dark">
                <tr>
                  <th>ÊéíÂêç</th>
                  <th>ËΩ¶Èòü</th>
                  <th>ÁßØÂàÜ</th>
                  <th>Ëé∑ËÉúÊ¨°Êï∞</th>
                </tr>
              </thead>
              <tbody>
        `;

        constructorsData.forEach((constructor, index) => {
          const rowClass =
            index === 0 ? "table-warning" : index < 3 ? "table-success" : "";
          const medal =
            index === 0 ? "üèÜ" : index === 1 ? "ü•à" : index === 2 ? "ü•â" : "";

          html += `
            <tr class="${rowClass}">
              <td>
                <span class="badge bg-primary">${constructor.position}</span>
                ${medal}
              </td>
              <td>
                <strong>${
                  constructor.team_name || constructor.constructor_name
                }</strong>
                <br>
                <small class="text-muted">${
                  constructor.nationality || ""
                }</small>
              </td>
              <td>
                <span class="badge bg-success fs-6">${constructor.points}</span>
              </td>
              <td>${constructor.wins || 0}</td>
            </tr>
          `;
        });

        html += `
              </tbody>
            </table>
          </div>
        `;

        return html;
      }

      // Ë∂≥ÁêÉÁßØÂàÜÊ¶úÂèØËßÜÂåñ
      function generateFootballStandingsVisualization(data) {
        if (!data.standings || data.standings.length === 0) {
          return '<div class="alert alert-warning">ÊöÇÊó†ÁßØÂàÜÊ¶úÊï∞ÊçÆ</div>';
        }

        const standings = data.standings[0].table;

        let html = `
          <div class="alert alert-success">
            <i class="fas fa-futbol"></i> 
            ${data.competition.name} - ${data.season.startDate} ËµõÂ≠£
          </div>
          <div class="table-responsive">
            <table class="table table-hover table-striped">
              <thead class="table-dark">
                <tr>
                  <th>ÊéíÂêç</th>
                  <th>ÁêÉÈòü</th>
                  <th>Âú∫Ê¨°</th>
                  <th>ËÉú</th>
                  <th>Âπ≥</th>
                  <th>Ë¥ü</th>
                  <th>ÁßØÂàÜ</th>
                </tr>
              </thead>
              <tbody>
        `;

        standings.forEach((team, index) => {
          let rowClass = "";
          if (team.position <= 4) {
            rowClass = "table-success"; // Ê¨ßÂÜ†Âå∫
          } else if (team.position <= 6) {
            rowClass = "table-info"; // Ê¨ßËÅîÊùØÂå∫
          } else if (team.position >= standings.length - 2) {
            rowClass = "table-danger"; // ÈôçÁ∫ßÂå∫
          }

          html += `
            <tr class="${rowClass}">
              <td><span class="badge bg-primary">${team.position}</span></td>
              <td><strong>${team.team.name}</strong></td>
              <td>${team.playedGames}</td>
              <td class="text-success">${team.won}</td>
              <td class="text-warning">${team.draw}</td>
              <td class="text-danger">${team.lost}</td>
              <td><span class="badge bg-success fs-6">${team.points}</span></td>
            </tr>
          `;
        });

        html += `
              </tbody>
            </table>
          </div>
          <div class="mt-2">
            <small class="text-muted">
              <span class="badge bg-success">1-4</span> Ê¨ßÂÜ†ËµÑÊ†º |
              <span class="badge bg-info">5-6</span> Ê¨ßËÅîÊùØËµÑÊ†º |
              <span class="badge bg-danger">ÈôçÁ∫ßÂå∫</span>
            </small>
          </div>
        `;

        return html;
      }

      // Ë∂≥ÁêÉÊØîËµõÂèØËßÜÂåñ
      function generateFootballMatchesVisualization(data) {
        if (!data.matches || data.matches.length === 0) {
          return '<div class="alert alert-warning">ÊöÇÊó†ÊØîËµõÊï∞ÊçÆ</div>';
        }

        let html = `
          <div class="alert alert-success">
            <i class="fas fa-calendar-day"></i> 
            Ë∂≥ÁêÉÊØîËµõ - ÂÖ± ${data.matches.length} Âú∫ÊØîËµõ
          </div>
          <div class="row">
        `;

        data.matches.forEach((match) => {
          const matchDate = new Date(match.utc_date).toLocaleString();
          const statusBadge =
            match.status === "FINISHED"
              ? "bg-success"
              : match.status === "IN_PLAY"
              ? "bg-warning"
              : "bg-secondary";

          html += `
            <div class="col-md-6 mb-3">
              <div class="card">
                <div class="card-body">
                  <div class="text-center">
                    <div class="row align-items-center">
                      <div class="col-4 text-end">
                        <strong>${match.home_team.name}</strong>
                      </div>
                      <div class="col-4">
                        <span class="badge ${statusBadge}">${
            match.status
          }</span>
                        <br>
                        ${
                          match.score && match.score.full_time
                            ? `<span class="fs-4">${match.score.full_time.home} - ${match.score.full_time.away}</span>`
                            : '<span class="text-muted">VS</span>'
                        }
                      </div>
                      <div class="col-4 text-start">
                        <strong>${match.away_team.name}</strong>
                      </div>
                    </div>
                    <small class="text-muted">${matchDate}</small>
                  </div>
                </div>
              </div>
            </div>
          `;
        });

        html += "</div>";
        return html;
      }

      // ÊòæÁ§∫Êü•ËØ¢ÂéÜÂè≤
      function displayQueryHistory(queries) {
        if (!queries || queries.length === 0) {
          queryHistory.innerHTML =
            '<p class="text-muted text-center">ÊöÇÊó†Êü•ËØ¢ÂéÜÂè≤</p>';
          return;
        }

        let historyHtml = "";
        queries.forEach((query, index) => {
          const time = new Date(query.timestamp).toLocaleString();
          historyHtml += `
                    <div class="history-item">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <strong>${query.text}</strong>
                                <br>
                                <small class="text-muted">
                                    <span class="badge bg-secondary">${query.query_info.sport}</span>
                                    ${time}
                                </small>
                            </div>
                            <button class="btn btn-sm btn-outline-primary" onclick="repeatQuery('${query.text}')">
                                <i class="fas fa-redo"></i>
                            </button>
                        </div>
                    </div>
                `;
        });

        queryHistory.innerHTML = historyHtml;
      }

      // ÈáçÂ§çÊü•ËØ¢
      function repeatQuery(text) {
        textInput.value = text;
        executeTextQuery();
      }

      // Âä†ËΩΩÊü•ËØ¢ÂéÜÂè≤
      function loadQueryHistory() {
        socket.emit("get_query_history");
      }

      // ÊâßË°åÊñáÊú¨Êü•ËØ¢
      function executeTextQuery() {
        const text = textInput.value.trim();
        if (!text) {
          alert("ËØ∑ËæìÂÖ•Êü•ËØ¢ÂÜÖÂÆπ");
          return;
        }

        textQueryBtn.disabled = true;
        textQueryBtn.innerHTML =
          '<span class="loading-spinner"></span> Êü•ËØ¢‰∏≠...';

        socket.emit("text_query", { text: text });

        // ÈáçÁΩÆÊåâÈíÆÁä∂ÊÄÅ
        setTimeout(() => {
          textQueryBtn.disabled = false;
          textQueryBtn.innerHTML = '<i class="fas fa-search"></i> Êü•ËØ¢';
        }, 3000);
      }

      // ‰∫ã‰ª∂ÁõëÂê¨
      voiceButton.addEventListener("click", function () {
        if (!systemReady) return;

        if (currentStep === "recorded") {
          // Á¨¨‰∫åÊ≠•ÔºöËØÜÂà´Èü≥È¢ë
          if (currentAudioFile) {
            socket.emit("recognize_audio", { audio_file: currentAudioFile });
          }
        } else if (currentStep === "recognized") {
          // Á¨¨‰∏âÊ≠•ÔºöÂ§ÑÁêÜÊü•ËØ¢
          if (currentText) {
            socket.emit("process_query", { text: currentText });
          }
        }
      });

      textQueryBtn.addEventListener("click", executeTextQuery);

      textInput.addEventListener("keypress", function (e) {
        if (e.key === "Enter") {
          executeTextQuery();
        }
      });

      refreshHistoryBtn.addEventListener("click", loadQueryHistory);

      // Ëé∑ÂèñÊúÄÊñ∞ÂΩïÈü≥
      function getLatestRecording() {
        socket.emit("get_latest_recording");
      }

      // ÊòæÁ§∫ÂΩïÈü≥Êñá‰ª∂ÂàóË°®
      function showRecordingsList() {
        const recordingsList = document.getElementById("recordingsList");
        if (recordingsList.classList.contains("d-none")) {
          socket.emit("get_recordings");
          recordingsList.classList.remove("d-none");
        } else {
          recordingsList.classList.add("d-none");
        }
      }

      // ÊòæÁ§∫ÂΩïÈü≥Êñá‰ª∂ÂàóË°®
      function displayRecordingsList(recordings) {
        const recordingsContent = document.getElementById("recordingsContent");

        if (!recordings || recordings.length === 0) {
          recordingsContent.innerHTML =
            '<p class="text-muted">Ê≤°ÊúâÊâæÂà∞ÂΩïÈü≥Êñá‰ª∂</p>';
          return;
        }

        let html = '<div class="list-group">';
        recordings.forEach((recording, index) => {
          // ËΩ¨‰πâË∑ØÂæÑ‰∏≠ÁöÑÂèçÊñúÊù†ÔºåÈò≤Ê≠¢JavaScriptËß£ÈáäÈîôËØØ
          const escapedPath = recording.path.replace(/\\/g, "\\\\");
          html += `
            <div class="list-group-item list-group-item-action" onclick="selectRecording('${escapedPath}')">
              <div class="d-flex w-100 justify-content-between">
                <h6 class="mb-1">${recording.filename}</h6>
                <small>${recording.time}</small>
              </div>
              <p class="mb-1">Â§ßÂ∞è: ${recording.size_kb} KB</p>
            </div>
          `;
        });
        html += "</div>";

        recordingsContent.innerHTML = html;
      }

      // ÈÄâÊã©ÂΩïÈü≥Êñá‰ª∂
      function selectRecording(audioFile) {
        currentAudioFile = audioFile;
        currentStep = "recorded";

        voiceButton.className = "voice-button";
        voiceButton.innerHTML = '<i class="fas fa-play"></i>';
        voiceButton.disabled = false;

        statusMessage.innerHTML = `<p class="text-success">Â∑≤ÈÄâÊã©ÂΩïÈü≥Êñá‰ª∂</p><p class="text-info">ÁÇπÂáªÊåâÈíÆÂºÄÂßãËØÜÂà´</p>`;

        // ÈöêËóèÂΩïÈü≥ÂàóË°®
        document.getElementById("recordingsList").classList.add("d-none");
      }

      // È°µÈù¢Âä†ËΩΩÂÆåÊàêÂêéÊ£ÄÊü•Á≥ªÁªüÁä∂ÊÄÅ
      document.addEventListener("DOMContentLoaded", function () {
        fetch("/api/voice/status")
          .then((response) => response.json())
          .then((data) => {
            updateSystemStatus(data.ready);
          })
          .catch((error) => {
            console.error("Ëé∑ÂèñÁ≥ªÁªüÁä∂ÊÄÅÂ§±Ë¥•:", error);
            updateSystemStatus(false, "Êó†Ê≥ïËøûÊé•Âà∞ÊúçÂä°Âô®");
          });
      });
    </script>
  </body>
</html>
