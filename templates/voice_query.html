<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ğŸ¤ è¯­éŸ³æŸ¥è¯¢ - ä½“è‚²æ•°æ®å¹³å°</title>

    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <!-- Font Awesome -->
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
      rel="stylesheet"
    />
    <!-- Socket.IO -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>

    <style>
      :root {
        --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        --success-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        --danger-gradient: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
      }

      body {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      }

      .voice-container {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 20px;
        padding: 2rem;
        box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
        backdrop-filter: blur(10px);
        margin: 2rem 0;
      }

      .voice-button {
        width: 200px;
        height: 200px;
        border-radius: 50%;
        border: none;
        font-size: 4rem;
        color: white;
        background: var(--primary-gradient);
        box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
      }

      .voice-button:hover {
        transform: scale(1.05);
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
      }

      .voice-button:active {
        transform: scale(0.95);
      }

      .voice-button.recording {
        background: var(--danger-gradient);
        animation: pulse-recording 1.5s infinite;
      }

      .voice-button.processing {
        background: var(--success-gradient);
        animation: spin 2s linear infinite;
      }

      @keyframes pulse-recording {
        0% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.1);
        }
        100% {
          transform: scale(1);
        }
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .status-card {
        background: white;
        border-radius: 15px;
        padding: 1.5rem;
        margin: 1rem 0;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
      }

      .status-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 15px 35px rgba(0, 0, 0, 0.15);
      }

      .result-card {
        background: white;
        border-radius: 15px;
        padding: 2rem;
        margin: 1rem 0;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        border-left: 5px solid #667eea;
      }

      .query-history {
        max-height: 400px;
        overflow-y: auto;
      }

      .history-item {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 1rem;
        margin: 0.5rem 0;
        border-left: 3px solid #667eea;
        transition: all 0.3s ease;
      }

      .history-item:hover {
        background: #e9ecef;
        transform: translateX(5px);
      }

      .navbar-custom {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        box-shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
      }

      .text-input-card {
        background: white;
        border-radius: 15px;
        padding: 1.5rem;
        margin: 1rem 0;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
      }

      .btn-gradient {
        background: var(--primary-gradient);
        border: none;
        color: white;
        border-radius: 25px;
        padding: 10px 25px;
        font-weight: 600;
        transition: all 0.3s ease;
      }

      .btn-gradient:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
        color: white;
      }

      .loading-spinner {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top-color: #fff;
        animation: spin 1s ease-in-out infinite;
      }

      .wave-animation {
        display: inline-block;
        width: 4px;
        height: 20px;
        background: white;
        margin: 0 2px;
        animation: wave 1.2s infinite ease-in-out;
      }

      .wave-animation:nth-child(2) {
        animation-delay: -1.1s;
      }
      .wave-animation:nth-child(3) {
        animation-delay: -1s;
      }
      .wave-animation:nth-child(4) {
        animation-delay: -0.9s;
      }
      .wave-animation:nth-child(5) {
        animation-delay: -0.8s;
      }

      @keyframes wave {
        0%,
        40%,
        100% {
          transform: scaleY(0.4);
        }
        20% {
          transform: scaleY(1);
        }
      }

      /* å¯è§†åŒ–å±•ç¤ºæ ·å¼ */
      .player-card {
        transition: all 0.3s ease;
        border: 1px solid #dee2e6;
      }

      .player-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        border-color: #667eea;
      }

      .visualization-card {
        background: white;
        border-radius: 10px;
        padding: 1rem;
        margin: 0.5rem 0;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
      }

      .visualization-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
      }

      .position-badge {
        background: linear-gradient(45deg, #667eea, #764ba2);
        color: white;
        padding: 0.25rem 0.5rem;
        border-radius: 15px;
        font-size: 0.8rem;
        font-weight: 600;
      }

      .team-logo {
        width: 24px;
        height: 24px;
        object-fit: contain;
        border-radius: 50%;
      }

      .standings-table {
        font-size: 0.9rem;
      }

      .standings-table th {
        background: linear-gradient(45deg, #667eea, #764ba2);
        color: white;
        border: none;
        font-weight: 600;
        text-align: center;
      }

      .match-card {
        background: white;
        border-radius: 10px;
        padding: 1rem;
        margin: 0.5rem 0;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
        border-left: 4px solid #667eea;
      }

      .match-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
      }

      .score-display {
        font-size: 1.5rem;
        font-weight: bold;
        color: #667eea;
      }

      .status-live {
        animation: pulse-live 2s infinite;
      }

      @keyframes pulse-live {
        0% {
          opacity: 1;
        }
        50% {
          opacity: 0.7;
        }
        100% {
          opacity: 1;
        }
      }

      /* æŠ˜å æŒ‰é’®æ ·å¼ */
      .collapse-btn {
        transition: all 0.3s ease;
      }

      .collapse-btn:hover {
        transform: scale(1.05);
      }

      /* å“åº”å¼è°ƒæ•´ */
      @media (max-width: 768px) {
        .player-card {
          margin-bottom: 1rem;
        }

        .standings-table {
          font-size: 0.8rem;
        }

        .match-card {
          margin-bottom: 1rem;
        }
      }
    </style>
  </head>
  <body>
    <!-- å¯¼èˆªæ  -->
    <nav class="navbar navbar-expand-lg navbar-custom">
      <div class="container">
        <a class="navbar-brand" href="/">
          <i class="fas fa-microphone-alt text-primary"></i>
          è¯­éŸ³ä½“è‚²æŸ¥è¯¢
        </a>
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarNav"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav ms-auto">
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="fas fa-home"></i> é¦–é¡µ
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link active" href="/voice">
                <i class="fas fa-microphone"></i> è¯­éŸ³æŸ¥è¯¢
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/f1">
                <i class="fas fa-flag-checkered"></i> F1
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/football">
                <i class="fas fa-futbol"></i> è¶³çƒ
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/nba">
                <i class="fas fa-basketball-ball"></i> NBA
              </a>
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <!-- ä¸»è¦å†…å®¹ -->
    <div class="container" style="padding-top: 100px">
      <div class="row">
        <!-- è¯­éŸ³æŸ¥è¯¢åŒºåŸŸ -->
        <div class="col-lg-8">
          <div class="voice-container text-center">
            <h2 class="mb-4">
              <i class="fas fa-microphone text-primary"></i>
              è¯­éŸ³æŸ¥è¯¢
            </h2>

            <!-- ç³»ç»ŸçŠ¶æ€ -->
            <div class="mb-4">
              <span id="systemStatus" class="badge bg-warning fs-6">
                <span class="loading-spinner"></span>
                ç³»ç»Ÿåˆå§‹åŒ–ä¸­...
              </span>
            </div>

            <!-- è¯­éŸ³æŒ‰é’® -->
            <div class="mb-4">
              <button id="voiceButton" class="voice-button" disabled>
                <i class="fas fa-microphone"></i>
              </button>
            </div>

            <!-- å½•éŸ³æ–‡ä»¶é€‰æ‹© -->
            <div class="mb-3">
              <div class="alert alert-info">
                <i class="fas fa-info-circle"></i>
                <strong>ä½¿ç”¨æ­¥éª¤ï¼š</strong><br />
                1. å…ˆè¿è¡Œ
                <code
                  >python "Speech Recognition/simple_voice_recorder.py"</code
                >
                å½•éŸ³<br />
                2. ç‚¹å‡»"ä½¿ç”¨æœ€æ–°å½•éŸ³"æˆ–é€‰æ‹©å½•éŸ³æ–‡ä»¶<br />
                3. æŒ‰æ­¥éª¤è¿›è¡Œè¯†åˆ«å’ŒæŸ¥è¯¢
              </div>
              <button
                id="getLatestBtn"
                class="btn btn-primary me-2"
                onclick="getLatestRecording()"
              >
                <i class="fas fa-file-audio"></i> ä½¿ç”¨æœ€æ–°å½•éŸ³
              </button>
              <button
                id="showRecordingsBtn"
                class="btn btn-outline-secondary"
                onclick="showRecordingsList()"
              >
                <i class="fas fa-list"></i> é€‰æ‹©å½•éŸ³æ–‡ä»¶
              </button>
            </div>

            <!-- å½•éŸ³æ–‡ä»¶åˆ—è¡¨ -->
            <div id="recordingsList" class="mb-3 d-none">
              <div class="card">
                <div class="card-header">
                  <h6 class="mb-0">é€‰æ‹©å½•éŸ³æ–‡ä»¶</h6>
                </div>
                <div class="card-body" id="recordingsContent">
                  <p class="text-muted">åŠ è½½ä¸­...</p>
                </div>
              </div>
            </div>

            <!-- çŠ¶æ€æç¤º -->
            <div id="statusMessage" class="mb-3">
              <p class="text-muted">è¯·å…ˆå½•éŸ³ï¼Œç„¶åé€‰æ‹©å½•éŸ³æ–‡ä»¶å¼€å§‹è¯†åˆ«</p>
            </div>

            <!-- è¯­éŸ³æ³¢å½¢åŠ¨ç”» -->
            <div id="waveAnimation" class="d-none mb-3">
              <div class="wave-animation"></div>
              <div class="wave-animation"></div>
              <div class="wave-animation"></div>
              <div class="wave-animation"></div>
              <div class="wave-animation"></div>
            </div>
          </div>

          <!-- æ–‡æœ¬æŸ¥è¯¢åŒºåŸŸ -->
          <div class="text-input-card">
            <h5 class="mb-3">
              <i class="fas fa-keyboard text-primary"></i>
              æ–‡æœ¬æŸ¥è¯¢
            </h5>
            <div class="input-group">
              <input
                type="text"
                id="textInput"
                class="form-control"
                placeholder="è¾“å…¥æŸ¥è¯¢å†…å®¹ï¼Œå¦‚ï¼šæŸ¥è¯¢F1ç§¯åˆ†æ¦œ"
              />
              <button id="textQueryBtn" class="btn btn-gradient">
                <i class="fas fa-search"></i> æŸ¥è¯¢
              </button>
            </div>
            <small class="text-muted mt-2 d-block">
              ğŸ’¡ ç¤ºä¾‹ï¼šæŸ¥è¯¢F1è½¦æ‰‹ç§¯åˆ†æ¦œã€æ¹–äººé˜Ÿèµ›ç¨‹ã€è‹±è¶…ç§¯åˆ†æ¦œ
            </small>
          </div>

          <!-- æŸ¥è¯¢ç»“æœåŒºåŸŸ -->
          <div id="queryResults" class="d-none">
            <div class="result-card">
              <h5 class="mb-3">
                <i class="fas fa-chart-bar text-success"></i>
                æŸ¥è¯¢ç»“æœ
              </h5>
              <div id="resultContent">
                <!-- ç»“æœå†…å®¹å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
              </div>
            </div>
          </div>
        </div>

        <!-- ä¾§è¾¹æ  -->
        <div class="col-lg-4">
          <!-- ä½¿ç”¨è¯´æ˜ -->
          <div class="status-card">
            <h5 class="mb-3">
              <i class="fas fa-info-circle text-info"></i>
              ä½¿ç”¨è¯´æ˜
            </h5>
            <ul class="list-unstyled">
              <li class="mb-2">
                <i class="fas fa-microphone text-primary"></i>
                ç‚¹å‡»éº¦å…‹é£æŒ‰é’®å¼€å§‹å½•éŸ³
              </li>
              <li class="mb-2">
                <i class="fas fa-volume-up text-success"></i>
                æ¸…æ™°è¯´å‡ºæŸ¥è¯¢éœ€æ±‚
              </li>
              <li class="mb-2">
                <i class="fas fa-stop text-danger"></i>
                å†æ¬¡ç‚¹å‡»åœæ­¢å½•éŸ³
              </li>
              <li class="mb-2">
                <i class="fas fa-magic text-warning"></i>
                ç³»ç»Ÿè‡ªåŠ¨è¯†åˆ«å¹¶æŸ¥è¯¢
              </li>
            </ul>
          </div>

          <!-- æŸ¥è¯¢ç¤ºä¾‹ -->
          <div class="status-card">
            <h5 class="mb-3">
              <i class="fas fa-lightbulb text-warning"></i>
              æŸ¥è¯¢ç¤ºä¾‹
            </h5>
            <div class="mb-2">
              <span class="badge bg-primary">F1</span>
              <small class="ms-2">æŸ¥è¯¢F1è½¦æ‰‹ç§¯åˆ†æ¦œ</small>
            </div>
            <div class="mb-2">
              <span class="badge bg-success">è¶³çƒ</span>
              <small class="ms-2">è‹±è¶…ç§¯åˆ†æ¦œ</small>
            </div>
            <div class="mb-2">
              <span class="badge bg-warning">NBA</span>
              <small class="ms-2">æ¹–äººé˜Ÿçš„èµ›ç¨‹</small>
            </div>
            <div class="mb-2">
              <span class="badge bg-info">å®æ—¶</span>
              <small class="ms-2">ä»Šå¤©çš„è¶³çƒæ¯”èµ›</small>
            </div>
          </div>

          <!-- æŸ¥è¯¢å†å² -->
          <div class="status-card">
            <h5 class="mb-3">
              <i class="fas fa-history text-secondary"></i>
              æŸ¥è¯¢å†å²
              <button
                id="refreshHistoryBtn"
                class="btn btn-sm btn-outline-secondary float-end"
              >
                <i class="fas fa-refresh"></i>
              </button>
            </h5>
            <div id="queryHistory" class="query-history">
              <p class="text-muted text-center">æš‚æ— æŸ¥è¯¢å†å²</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      // åˆå§‹åŒ–Socket.IOè¿æ¥
      const socket = io();

      // DOMå…ƒç´ 
      const systemStatus = document.getElementById("systemStatus");
      const voiceButton = document.getElementById("voiceButton");
      const statusMessage = document.getElementById("statusMessage");
      const waveAnimation = document.getElementById("waveAnimation");
      const textInput = document.getElementById("textInput");
      const textQueryBtn = document.getElementById("textQueryBtn");
      const queryResults = document.getElementById("queryResults");
      const resultContent = document.getElementById("resultContent");
      const queryHistory = document.getElementById("queryHistory");
      const refreshHistoryBtn = document.getElementById("refreshHistoryBtn");

      // çŠ¶æ€å˜é‡
      let currentStep = "ready"; // ready, recording, recorded, recognizing, recognized, processing
      let currentAudioFile = null;
      let currentText = null;
      let systemReady = false;

      // Socketäº‹ä»¶ç›‘å¬
      socket.on("connect", function () {
        console.log("å·²è¿æ¥åˆ°æœåŠ¡å™¨");
        loadQueryHistory();
      });

      socket.on("voice_system_status", function (data) {
        updateSystemStatus(data.ready);
      });

      socket.on("voice_system_ready", function (data) {
        updateSystemStatus(true);
      });

      socket.on("voice_system_error", function (data) {
        updateSystemStatus(false, data.error);
      });

      socket.on("voice_query_status", function (data) {
        updateQueryStatus(data.status, data.message);
      });

      socket.on("recording_complete", function (data) {
        handleRecordingComplete(data);
      });

      socket.on("recognition_complete", function (data) {
        handleRecognitionComplete(data);
      });

      socket.on("voice_query_success", function (data) {
        handleQuerySuccess(data);
      });

      socket.on("voice_query_error", function (data) {
        handleQueryError(data.error, data.suggestion);
      });

      socket.on("query_success", function (data) {
        handleQuerySuccess(data);
      });

      socket.on("query_error", function (data) {
        handleQueryError(data.error, data.suggestion);
      });

      socket.on("query_history", function (data) {
        displayQueryHistory(data.queries);
      });

      socket.on("recordings_list", function (data) {
        displayRecordingsList(data.recordings);
      });

      // æ›´æ–°ç³»ç»ŸçŠ¶æ€
      function updateSystemStatus(ready, error = null) {
        systemReady = ready;

        if (ready) {
          systemStatus.className = "badge bg-success fs-6";
          systemStatus.innerHTML =
            '<i class="fas fa-check-circle"></i> è¯­éŸ³ç³»ç»Ÿå°±ç»ª';
          voiceButton.disabled = true; // é»˜è®¤ç¦ç”¨ï¼Œéœ€è¦å…ˆé€‰æ‹©å½•éŸ³æ–‡ä»¶
          statusMessage.innerHTML =
            '<p class="text-success">ç³»ç»Ÿå°±ç»ªï¼Œè¯·å…ˆå½•éŸ³ç„¶åé€‰æ‹©å½•éŸ³æ–‡ä»¶</p>';
        } else {
          if (error) {
            systemStatus.className = "badge bg-danger fs-6";
            systemStatus.innerHTML =
              '<i class="fas fa-exclamation-circle"></i> ç³»ç»Ÿé”™è¯¯';
            statusMessage.innerHTML = `<p class="text-danger">ç³»ç»Ÿé”™è¯¯: ${error}</p>`;
          } else {
            systemStatus.className = "badge bg-warning fs-6";
            systemStatus.innerHTML =
              '<span class="loading-spinner"></span> ç³»ç»Ÿåˆå§‹åŒ–ä¸­...';
            statusMessage.innerHTML =
              '<p class="text-warning">ç³»ç»Ÿåˆå§‹åŒ–ä¸­ï¼Œè¯·ç¨å€™...</p>';
          }
          voiceButton.disabled = true;
        }
      }

      // æ›´æ–°æŸ¥è¯¢çŠ¶æ€
      function updateQueryStatus(status, message) {
        if (status === "recording") {
          currentStep = "recording";
          voiceButton.className = "voice-button recording";
          voiceButton.innerHTML = '<i class="fas fa-microphone"></i>';
          voiceButton.disabled = true;
          statusMessage.innerHTML = `<p class="text-danger">${message}</p>`;
          waveAnimation.classList.remove("d-none");
        } else if (status === "recognizing") {
          currentStep = "recognizing";
          voiceButton.className = "voice-button processing";
          voiceButton.innerHTML = '<span class="loading-spinner"></span>';
          voiceButton.disabled = true;
          statusMessage.innerHTML = `<p class="text-info">${message}</p>`;
          waveAnimation.classList.add("d-none");
        } else if (status === "processing") {
          currentStep = "processing";
          voiceButton.className = "voice-button processing";
          voiceButton.innerHTML = '<span class="loading-spinner"></span>';
          voiceButton.disabled = true;
          statusMessage.innerHTML = `<p class="text-info">${message}</p>`;
          waveAnimation.classList.add("d-none");
        }
      }

      // å¤„ç†å½•éŸ³å®Œæˆ
      function handleRecordingComplete(data) {
        currentStep = "recorded";
        currentAudioFile = data.audio_file;

        voiceButton.className = "voice-button";
        voiceButton.innerHTML = '<i class="fas fa-play"></i>';
        voiceButton.disabled = false;
        waveAnimation.classList.add("d-none");

        statusMessage.innerHTML = `<p class="text-success">${data.message}</p><p class="text-info">ç‚¹å‡»æŒ‰é’®å¼€å§‹è¯†åˆ«</p>`;
      }

      // å¤„ç†è¯†åˆ«å®Œæˆ
      function handleRecognitionComplete(data) {
        currentStep = "recognized";
        currentText = data.text;

        voiceButton.className = "voice-button";
        voiceButton.innerHTML = '<i class="fas fa-search"></i>';
        voiceButton.disabled = false;

        statusMessage.innerHTML = `<p class="text-success">è¯†åˆ«æˆåŠŸ: "${data.text}"</p><p class="text-info">ç‚¹å‡»æŒ‰é’®å¼€å§‹æŸ¥è¯¢</p>`;
      }

      // å¤„ç†æŸ¥è¯¢æˆåŠŸ
      function handleQuerySuccess(data) {
        resetVoiceButton();

        // æ˜¾ç¤ºè¯†åˆ«æ–‡æœ¬
        statusMessage.innerHTML = `<p class="text-success">è¯†åˆ«æˆåŠŸ: "${data.text}"</p>`;

        // æ˜¾ç¤ºæŸ¥è¯¢ç»“æœ
        displayQueryResult(data);

        // åˆ·æ–°æŸ¥è¯¢å†å²
        loadQueryHistory();
      }

      // å¤„ç†æŸ¥è¯¢é”™è¯¯
      function handleQueryError(error, suggestion = "") {
        resetVoiceButton();

        let errorHtml = `<p class="text-danger">æŸ¥è¯¢å¤±è´¥: ${error}</p>`;
        if (suggestion) {
          errorHtml += `<p class="text-info">å»ºè®®: ${suggestion}</p>`;
        }
        statusMessage.innerHTML = errorHtml;
      }

      // é‡ç½®è¯­éŸ³æŒ‰é’®
      function resetVoiceButton() {
        currentStep = "ready";
        currentAudioFile = null;
        currentText = null;
        voiceButton.className = "voice-button";
        voiceButton.innerHTML = '<i class="fas fa-microphone"></i>';
        voiceButton.disabled = !systemReady;
        waveAnimation.classList.add("d-none");
      }

      // æ˜¾ç¤ºæŸ¥è¯¢ç»“æœ
      function displayQueryResult(data) {
        const queryInfo = data.query_info;
        const resultData = data.data;

        let resultHtml = `
                <div class="mb-3">
                    <h6><i class="fas fa-info-circle"></i> æŸ¥è¯¢ä¿¡æ¯</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>è¯†åˆ«æ–‡æœ¬:</strong> ${data.text}</p>
                            <p><strong>ä½“è‚²é¡¹ç›®:</strong> <span class="badge bg-primary">${
                              queryInfo.sport
                            }</span></p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>æŸ¥è¯¢ç±»å‹:</strong> <span class="badge bg-success">${
                              queryInfo.query_type
                            }</span></p>
                            <p><strong>ç½®ä¿¡åº¦:</strong> <span class="badge bg-info">${(
                              queryInfo.confidence * 100
                            ).toFixed(1)}%</span></p>
                        </div>
                    </div>
                </div>
                <hr>
                <div class="mb-3">
                    <h6><i class="fas fa-chart-bar"></i> æ•°æ®å¯è§†åŒ–</h6>
                    <div id="visualizationContent">
                        ${generateVisualization(resultData, queryInfo)}
                    </div>
                </div>
                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <h6><i class="fas fa-code"></i> åŸå§‹æ•°æ®</h6>
                        <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#rawDataCollapse" aria-expanded="false">
                            <i class="fas fa-eye"></i> æŸ¥çœ‹/éšè—
                        </button>
                    </div>
                    <div class="collapse" id="rawDataCollapse">
                        <div class="card card-body mt-2">
                            <pre class="bg-light p-3 rounded small" style="max-height: 400px; overflow-y: auto;">${JSON.stringify(
                              resultData,
                              null,
                              2
                            )}</pre>
                        </div>
                    </div>
                </div>
            `;

        resultContent.innerHTML = resultHtml;
        queryResults.classList.remove("d-none");
      }

      // ç”Ÿæˆå¯è§†åŒ–å†…å®¹
      function generateVisualization(data, queryInfo) {
        if (!data || !data.success) {
          return '<div class="alert alert-danger">æŸ¥è¯¢å¤±è´¥æˆ–æ— æ•°æ®</div>';
        }

        const sport = queryInfo.sport;
        const queryType = queryInfo.query_type;

        // æ ¹æ®ä½“è‚²é¡¹ç›®å’ŒæŸ¥è¯¢ç±»å‹ç”Ÿæˆå¯¹åº”çš„å¯è§†åŒ–
        if (sport === "nba") {
          if (queryType === "standings") {
            return generateNBAStandingsVisualization(data);
          } else if (queryType === "players") {
            if (data.player) {
              return generatePlayerInfoVisualization(data);
            } else {
              return generateNBAPlayersVisualization(data);
            }
          } else if (queryType === "player_stats") {
            return generatePlayerStatsVisualization(data);
          } else if (queryType === "schedule") {
            return generateNBAScheduleVisualization(data);
          }
        } else if (sport === "f1") {
          if (queryType === "standings") {
            return generateF1DriversVisualization(data);
          } else if (queryType === "teams") {
            return generateF1ConstructorsVisualization(data);
          }
        } else if (sport === "football") {
          if (queryType === "standings") {
            return generateFootballStandingsVisualization(data);
          } else if (queryType === "top_scorers") {
            return generateTopScorersVisualization(data);
          } else if (queryType === "today" || queryType === "schedule") {
            return generateFootballMatchesVisualization(data);
          }
        }

        return '<div class="alert alert-warning">æš‚æ— å¯è§†åŒ–å±•ç¤ºï¼Œè¯·æŸ¥çœ‹åŸå§‹æ•°æ®</div>';
      }

      // çƒå‘˜ä¿¡æ¯å¯è§†åŒ–
      function generatePlayerInfoVisualization(data) {
        return `
          <div class="alert alert-info">
            <i class="fas fa-user"></i> 
            çƒå‘˜æŸ¥è¯¢: ${data.player}
          </div>
          <div class="card">
            <div class="card-body">
              <h5 class="card-title">${data.player}</h5>
              <p class="card-text">${data.message}</p>
              <small class="text-muted">è¯¦ç»†çƒå‘˜ä¿¡æ¯åŠŸèƒ½å¼€å‘ä¸­...</small>
            </div>
          </div>
        `;
      }

      // çƒå‘˜ç»Ÿè®¡æ•°æ®å¯è§†åŒ–
      function generatePlayerStatsVisualization(data) {
        return `
          <div class="alert alert-info">
            <i class="fas fa-chart-bar"></i> 
            çƒå‘˜ç»Ÿè®¡: ${data.player}
          </div>
          <div class="card">
            <div class="card-body">
              <h5 class="card-title">${data.player} ç»Ÿè®¡æ•°æ®</h5>
              <p class="card-text">${data.message}</p>
              <small class="text-muted">çƒå‘˜è¯¦ç»†ç»Ÿè®¡åŠŸèƒ½å¼€å‘ä¸­...</small>
            </div>
          </div>
        `;
      }

      // å°„æ‰‹æ¦œå¯è§†åŒ–
      function generateTopScorersVisualization(data) {
        return `
          <div class="alert alert-info">
            <i class="fas fa-futbol"></i> 
            å°„æ‰‹æ¦œæŸ¥è¯¢
          </div>
          <div class="card">
            <div class="card-body">
              <h5 class="card-title">å°„æ‰‹æ¦œ</h5>
              <p class="card-text">${data.message}</p>
              <small class="text-muted">å°„æ‰‹æ¦œåŠŸèƒ½å¼€å‘ä¸­ï¼Œè¯·æŸ¥çœ‹è”èµ›ç§¯åˆ†æ¦œ...</small>
            </div>
          </div>
        `;
      }

      // NBAçƒå‘˜ä¿¡æ¯å¯è§†åŒ–
      function generateNBAPlayersVisualization(data) {
        if (!data.players || data.players.length === 0) {
          return '<div class="alert alert-warning">æš‚æ— çƒå‘˜æ•°æ®</div>';
        }

        // æŒ‰ä½ç½®åˆ†ç»„
        const playersByPosition = {
          G: [], // åå«
          F: [], // å‰é”‹
          C: [], // ä¸­é”‹
        };

        data.players.forEach((player) => {
          const pos = player.position.charAt(0);
          if (playersByPosition[pos]) {
            playersByPosition[pos].push(player);
          }
        });

        const positionNames = {
          G: "åå« (Guards)",
          F: "å‰é”‹ (Forwards)",
          C: "ä¸­é”‹ (Centers)",
        };

        let html = `
          <div class="alert alert-success">
            <i class="fas fa-basketball-ball"></i> 
            <strong>${data.team_name}</strong> çƒå‘˜åå• - å…± ${data.players.length} åçƒå‘˜
          </div>
          <div class="row">
        `;

        Object.keys(playersByPosition).forEach((position) => {
          const players = playersByPosition[position];
          if (players.length > 0) {
            html += `
              <div class="col-md-4 mb-3">
                <div class="card h-100">
                  <div class="card-header bg-primary text-white">
                    <h6 class="mb-0">
                      <i class="fas fa-users"></i> ${positionNames[position]} (${players.length})
                    </h6>
                  </div>
                  <div class="card-body p-2">
            `;

            players.forEach((player) => {
              // å®‰å…¨åœ°å¤„ç†çƒå‘˜å§“å
              const playerName =
                player.full_name ||
                (player.first_name && player.last_name
                  ? `${player.first_name} ${player.last_name}`
                  : player.display_name ||
                    `çƒå‘˜ #${player.jersey || "Unknown"}`);

              // å®‰å…¨åœ°å¤„ç†èº«é«˜
              const height =
                player.height_feet && player.height_inches !== null
                  ? `${player.height_feet}'${player.height_inches}"`
                  : player.height
                  ? `${player.height}"`
                  : "N/A";

              // å®‰å…¨åœ°å¤„ç†ç»éªŒ
              const experience =
                player.experience === "R"
                  ? "æ–°ç§€"
                  : player.experience
                  ? `${player.experience}å¹´`
                  : "N/A";

              // å®‰å…¨åœ°å¤„ç†å…¶ä»–å­—æ®µ
              const weight = player.weight_pounds
                ? `${player.weight_pounds}lbs`
                : "N/A";
              const age = player.age ? `${player.age}å²` : "N/A";
              const jersey = player.jersey || player.jersey_number || "N/A";

              html += `
                <div class="player-card mb-2 p-2 border rounded">
                  <div class="d-flex justify-content-between align-items-start">
                    <div>
                      <strong>${playerName}</strong>
                      <span class="badge bg-secondary ms-1">#${jersey}</span>
                      <br>
                      <small class="text-muted">
                        ${height} | ${weight} | ${age}
                        <br>
                        ${player.school || "N/A"} | ${experience}
                      </small>
                    </div>
                  </div>
                </div>
              `;
            });

            html += `
                  </div>
                </div>
              </div>
            `;
          }
        });

        html += "</div>";
        return html;
      }

      // NBAç§¯åˆ†æ¦œå¯è§†åŒ–
      function generateNBAStandingsVisualization(data) {
        if (!data.standings || data.standings.length === 0) {
          return '<div class="alert alert-warning">æš‚æ— ç§¯åˆ†æ¦œæ•°æ®</div>';
        }

        let html = `
          <div class="alert alert-success">
            <i class="fas fa-trophy"></i> 
            NBAè”ç›Ÿç§¯åˆ†æ¦œ - ${data.season || "å½“å‰èµ›å­£"}
          </div>
          <div class="row">
        `;

        // åˆ†ä¸œè¥¿éƒ¨æ˜¾ç¤º
        const conferences = ["Eastern", "Western"];
        const conferenceNames = {
          Eastern: "ä¸œéƒ¨è”ç›Ÿ",
          Western: "è¥¿éƒ¨è”ç›Ÿ",
        };

        conferences.forEach((conf) => {
          const teams = data.standings.filter(
            (team) => team.conference === conf
          );
          if (teams.length > 0) {
            html += `
              <div class="col-md-6 mb-3">
                <div class="card">
                  <div class="card-header bg-primary text-white">
                    <h6 class="mb-0">${conferenceNames[conf]}</h6>
                  </div>
                  <div class="card-body p-0">
                    <div class="table-responsive">
                      <table class="table table-sm table-hover mb-0">
                        <thead class="table-dark">
                          <tr>
                            <th>æ’å</th>
                            <th>çƒé˜Ÿ</th>
                            <th>èƒœ</th>
                            <th>è´Ÿ</th>
                            <th>èƒœç‡</th>
                          </tr>
                        </thead>
                        <tbody>
            `;

            teams.forEach((team, index) => {
              const winPct = (
                (team.wins / (team.wins + team.losses)) *
                100
              ).toFixed(1);
              const rowClass = index < 8 ? "table-success" : ""; // å­£åèµ›èµ„æ ¼

              html += `
                <tr class="${rowClass}">
                  <td><span class="badge bg-primary">${index + 1}</span></td>
                  <td><strong>${team.team_name}</strong></td>
                  <td class="text-success">${team.wins}</td>
                  <td class="text-danger">${team.losses}</td>
                  <td>${winPct}%</td>
                </tr>
              `;
            });

            html += `
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>
              </div>
            `;
          }
        });

        html += `
          </div>
          <div class="mt-2">
            <small class="text-muted">
              <span class="badge bg-success">ç»¿è‰²</span> å­£åèµ›èµ„æ ¼ (å‰8å)
            </small>
          </div>
        `;

        return html;
      }

      // NBAçƒé˜Ÿèµ›ç¨‹å¯è§†åŒ–
      function generateNBAScheduleVisualization(data) {
        if (!data.schedule || data.schedule.length === 0) {
          return '<div class="alert alert-warning">æš‚æ— èµ›ç¨‹æ•°æ®</div>';
        }

        let html = `
          <div class="alert alert-success">
            <i class="fas fa-calendar-day"></i> 
            NBAèµ›ç¨‹ - å…± ${data.schedule.length} åœºæ¯”èµ›
          </div>
          <div class="row">
        `;

        data.schedule.forEach((game) => {
          const matchDate = new Date(game.date).toLocaleString();
          const statusBadge =
            game.status === "FINISHED"
              ? "bg-success"
              : game.status === "IN_PLAY"
              ? "bg-warning"
              : "bg-secondary";

          html += `
            <div class="col-md-6 mb-3">
              <div class="card">
                <div class="card-body">
                  <div class="text-center">
                    <div class="row align-items-center">
                      <div class="col-4 text-end">
                        <strong>${game.home_team.name}</strong>
                      </div>
                      <div class="col-4">
                        <span class="badge ${statusBadge}">${game.status}</span>
                        <br>
                        ${
                          game.score && game.score.full_time
                            ? `<span class="fs-4">${game.score.full_time.home} - ${game.score.full_time.away}</span>`
                            : '<span class="text-muted">VS</span>'
                        }
                      </div>
                      <div class="col-4 text-start">
                        <strong>${game.away_team.name}</strong>
                      </div>
                    </div>
                    <small class="text-muted">${matchDate}</small>
                  </div>
                </div>
              </div>
            </div>
          `;
        });

        html += "</div>";
        return html;
      }

      // F1è½¦æ‰‹ç§¯åˆ†æ¦œå¯è§†åŒ–
      function generateF1DriversVisualization(data) {
        // æ£€æŸ¥æ•°æ®ç»“æ„ - æ”¯æŒ drivers æˆ– standings å­—æ®µ
        const driversData = data.drivers || data.standings;

        if (!driversData || driversData.length === 0) {
          return '<div class="alert alert-warning">æš‚æ— è½¦æ‰‹æ•°æ®</div>';
        }

        let html = `
          <div class="alert alert-success">
            <i class="fas fa-flag-checkered"></i> 
            F1è½¦æ‰‹ç§¯åˆ†æ¦œ - ${data.year || data.season || "å½“å‰èµ›å­£"}
          </div>
          <div class="table-responsive">
            <table class="table table-hover">
              <thead class="table-dark">
                <tr>
                  <th>æ’å</th>
                  <th>è½¦æ‰‹</th>
                  <th>è½¦é˜Ÿ</th>
                  <th>ç§¯åˆ†</th>
                  <th>è·èƒœæ¬¡æ•°</th>
                </tr>
              </thead>
              <tbody>
        `;

        driversData.forEach((driver, index) => {
          const rowClass =
            index === 0 ? "table-warning" : index < 3 ? "table-success" : "";
          const medal =
            index === 0 ? "ğŸ†" : index === 1 ? "ğŸ¥ˆ" : index === 2 ? "ğŸ¥‰" : "";

          html += `
            <tr class="${rowClass}">
              <td>
                <span class="badge bg-primary">${driver.position}</span>
                ${medal}
              </td>
              <td>
                <strong>${driver.driver_name}</strong>
                <br>
                <small class="text-muted">${driver.nationality || ""}</small>
              </td>
              <td>${driver.team_name || driver.constructor_name || ""}</td>
              <td>
                <span class="badge bg-success fs-6">${driver.points}</span>
              </td>
              <td>${driver.wins || 0}</td>
            </tr>
          `;
        });

        html += `
              </tbody>
            </table>
          </div>
          <div class="mt-2">
            <small class="text-muted">
              ğŸ† å† å†› | <span class="badge bg-success">å‰ä¸‰å</span> é¢†å¥–å°
            </small>
          </div>
        `;

        return html;
      }

      // F1è½¦é˜Ÿç§¯åˆ†æ¦œå¯è§†åŒ–
      function generateF1ConstructorsVisualization(data) {
        // æ£€æŸ¥æ•°æ®ç»“æ„ - æ”¯æŒ constructors æˆ– standings å­—æ®µ
        const constructorsData = data.constructors || data.standings;

        if (!constructorsData || constructorsData.length === 0) {
          return '<div class="alert alert-warning">æš‚æ— è½¦é˜Ÿæ•°æ®</div>';
        }

        let html = `
          <div class="alert alert-success">
            <i class="fas fa-trophy"></i> 
            F1è½¦é˜Ÿç§¯åˆ†æ¦œ - ${data.year || data.season || "å½“å‰èµ›å­£"}
          </div>
          <div class="table-responsive">
            <table class="table table-hover">
              <thead class="table-dark">
                <tr>
                  <th>æ’å</th>
                  <th>è½¦é˜Ÿ</th>
                  <th>ç§¯åˆ†</th>
                  <th>è·èƒœæ¬¡æ•°</th>
                </tr>
              </thead>
              <tbody>
        `;

        constructorsData.forEach((constructor, index) => {
          const rowClass =
            index === 0 ? "table-warning" : index < 3 ? "table-success" : "";
          const medal =
            index === 0 ? "ğŸ†" : index === 1 ? "ğŸ¥ˆ" : index === 2 ? "ğŸ¥‰" : "";

          html += `
            <tr class="${rowClass}">
              <td>
                <span class="badge bg-primary">${constructor.position}</span>
                ${medal}
              </td>
              <td>
                <strong>${
                  constructor.team_name || constructor.constructor_name
                }</strong>
                <br>
                <small class="text-muted">${
                  constructor.nationality || ""
                }</small>
              </td>
              <td>
                <span class="badge bg-success fs-6">${constructor.points}</span>
              </td>
              <td>${constructor.wins || 0}</td>
            </tr>
          `;
        });

        html += `
              </tbody>
            </table>
          </div>
        `;

        return html;
      }

      // è¶³çƒç§¯åˆ†æ¦œå¯è§†åŒ–
      function generateFootballStandingsVisualization(data) {
        if (!data.standings || data.standings.length === 0) {
          return '<div class="alert alert-warning">æš‚æ— ç§¯åˆ†æ¦œæ•°æ®</div>';
        }

        const standings = data.standings[0].table;

        let html = `
          <div class="alert alert-success">
            <i class="fas fa-futbol"></i> 
            ${data.competition.name} - ${data.season.startDate} èµ›å­£
          </div>
          <div class="table-responsive">
            <table class="table table-hover table-striped">
              <thead class="table-dark">
                <tr>
                  <th>æ’å</th>
                  <th>çƒé˜Ÿ</th>
                  <th>åœºæ¬¡</th>
                  <th>èƒœ</th>
                  <th>å¹³</th>
                  <th>è´Ÿ</th>
                  <th>ç§¯åˆ†</th>
                </tr>
              </thead>
              <tbody>
        `;

        standings.forEach((team, index) => {
          let rowClass = "";
          if (team.position <= 4) {
            rowClass = "table-success"; // æ¬§å† åŒº
          } else if (team.position <= 6) {
            rowClass = "table-info"; // æ¬§è”æ¯åŒº
          } else if (team.position >= standings.length - 2) {
            rowClass = "table-danger"; // é™çº§åŒº
          }

          html += `
            <tr class="${rowClass}">
              <td><span class="badge bg-primary">${team.position}</span></td>
              <td><strong>${team.team.name}</strong></td>
              <td>${team.playedGames}</td>
              <td class="text-success">${team.won}</td>
              <td class="text-warning">${team.draw}</td>
              <td class="text-danger">${team.lost}</td>
              <td><span class="badge bg-success fs-6">${team.points}</span></td>
            </tr>
          `;
        });

        html += `
              </tbody>
            </table>
          </div>
          <div class="mt-2">
            <small class="text-muted">
              <span class="badge bg-success">1-4</span> æ¬§å† èµ„æ ¼ |
              <span class="badge bg-info">5-6</span> æ¬§è”æ¯èµ„æ ¼ |
              <span class="badge bg-danger">é™çº§åŒº</span>
            </small>
          </div>
        `;

        return html;
      }

      // è¶³çƒæ¯”èµ›å¯è§†åŒ–
      function generateFootballMatchesVisualization(data) {
        if (!data.matches || data.matches.length === 0) {
          return '<div class="alert alert-warning">æš‚æ— æ¯”èµ›æ•°æ®</div>';
        }

        let html = `
          <div class="alert alert-success">
            <i class="fas fa-calendar-day"></i> 
            è¶³çƒæ¯”èµ› - å…± ${data.matches.length} åœºæ¯”èµ›
          </div>
          <div class="row">
        `;

        data.matches.forEach((match) => {
          const matchDate = new Date(match.utc_date).toLocaleString();
          const statusBadge =
            match.status === "FINISHED"
              ? "bg-success"
              : match.status === "IN_PLAY"
              ? "bg-warning"
              : "bg-secondary";

          html += `
            <div class="col-md-6 mb-3">
              <div class="card">
                <div class="card-body">
                  <div class="text-center">
                    <div class="row align-items-center">
                      <div class="col-4 text-end">
                        <strong>${match.home_team.name}</strong>
                      </div>
                      <div class="col-4">
                        <span class="badge ${statusBadge}">${
            match.status
          }</span>
                        <br>
                        ${
                          match.score && match.score.full_time
                            ? `<span class="fs-4">${match.score.full_time.home} - ${match.score.full_time.away}</span>`
                            : '<span class="text-muted">VS</span>'
                        }
                      </div>
                      <div class="col-4 text-start">
                        <strong>${match.away_team.name}</strong>
                      </div>
                    </div>
                    <small class="text-muted">${matchDate}</small>
                  </div>
                </div>
              </div>
            </div>
          `;
        });

        html += "</div>";
        return html;
      }

      // æ˜¾ç¤ºæŸ¥è¯¢å†å²
      function displayQueryHistory(queries) {
        if (!queries || queries.length === 0) {
          queryHistory.innerHTML =
            '<p class="text-muted text-center">æš‚æ— æŸ¥è¯¢å†å²</p>';
          return;
        }

        let historyHtml = "";
        queries.forEach((query, index) => {
          const time = new Date(query.timestamp).toLocaleString();
          historyHtml += `
                    <div class="history-item">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <strong>${query.text}</strong>
                                <br>
                                <small class="text-muted">
                                    <span class="badge bg-secondary">${query.query_info.sport}</span>
                                    ${time}
                                </small>
                            </div>
                            <button class="btn btn-sm btn-outline-primary" onclick="repeatQuery('${query.text}')">
                                <i class="fas fa-redo"></i>
                            </button>
                        </div>
                    </div>
                `;
        });

        queryHistory.innerHTML = historyHtml;
      }

      // é‡å¤æŸ¥è¯¢
      function repeatQuery(text) {
        textInput.value = text;
        executeTextQuery();
      }

      // åŠ è½½æŸ¥è¯¢å†å²
      function loadQueryHistory() {
        socket.emit("get_query_history");
      }

      // æ‰§è¡Œæ–‡æœ¬æŸ¥è¯¢
      function executeTextQuery() {
        const text = textInput.value.trim();
        if (!text) {
          alert("è¯·è¾“å…¥æŸ¥è¯¢å†…å®¹");
          return;
        }

        textQueryBtn.disabled = true;
        textQueryBtn.innerHTML =
          '<span class="loading-spinner"></span> æŸ¥è¯¢ä¸­...';

        socket.emit("text_query", { text: text });

        // é‡ç½®æŒ‰é’®çŠ¶æ€
        setTimeout(() => {
          textQueryBtn.disabled = false;
          textQueryBtn.innerHTML = '<i class="fas fa-search"></i> æŸ¥è¯¢';
        }, 3000);
      }

      // äº‹ä»¶ç›‘å¬
      voiceButton.addEventListener("click", function () {
        if (!systemReady) return;

        if (currentStep === "recorded") {
          // ç¬¬äºŒæ­¥ï¼šè¯†åˆ«éŸ³é¢‘
          if (currentAudioFile) {
            socket.emit("recognize_audio", { audio_file: currentAudioFile });
          }
        } else if (currentStep === "recognized") {
          // ç¬¬ä¸‰æ­¥ï¼šå¤„ç†æŸ¥è¯¢
          if (currentText) {
            socket.emit("process_query", { text: currentText });
          }
        }
      });

      textQueryBtn.addEventListener("click", executeTextQuery);

      textInput.addEventListener("keypress", function (e) {
        if (e.key === "Enter") {
          executeTextQuery();
        }
      });

      refreshHistoryBtn.addEventListener("click", loadQueryHistory);

      // è·å–æœ€æ–°å½•éŸ³
      function getLatestRecording() {
        socket.emit("get_latest_recording");
      }

      // æ˜¾ç¤ºå½•éŸ³æ–‡ä»¶åˆ—è¡¨
      function showRecordingsList() {
        const recordingsList = document.getElementById("recordingsList");
        if (recordingsList.classList.contains("d-none")) {
          socket.emit("get_recordings");
          recordingsList.classList.remove("d-none");
        } else {
          recordingsList.classList.add("d-none");
        }
      }

      // æ˜¾ç¤ºå½•éŸ³æ–‡ä»¶åˆ—è¡¨
      function displayRecordingsList(recordings) {
        const recordingsContent = document.getElementById("recordingsContent");

        if (!recordings || recordings.length === 0) {
          recordingsContent.innerHTML =
            '<p class="text-muted">æ²¡æœ‰æ‰¾åˆ°å½•éŸ³æ–‡ä»¶</p>';
          return;
        }

        let html = '<div class="list-group">';
        recordings.forEach((recording, index) => {
          // è½¬ä¹‰è·¯å¾„ä¸­çš„åæ–œæ ï¼Œé˜²æ­¢JavaScriptè§£é‡Šé”™è¯¯
          const escapedPath = recording.path.replace(/\\/g, "\\\\");
          html += `
            <div class="list-group-item list-group-item-action" onclick="selectRecording('${escapedPath}')">
              <div class="d-flex w-100 justify-content-between">
                <h6 class="mb-1">${recording.filename}</h6>
                <small>${recording.time}</small>
              </div>
              <p class="mb-1">å¤§å°: ${recording.size_kb} KB</p>
            </div>
          `;
        });
        html += "</div>";

        recordingsContent.innerHTML = html;
      }

      // é€‰æ‹©å½•éŸ³æ–‡ä»¶
      function selectRecording(audioFile) {
        currentAudioFile = audioFile;
        currentStep = "recorded";

        voiceButton.className = "voice-button";
        voiceButton.innerHTML = '<i class="fas fa-play"></i>';
        voiceButton.disabled = false;

        statusMessage.innerHTML = `<p class="text-success">å·²é€‰æ‹©å½•éŸ³æ–‡ä»¶</p><p class="text-info">ç‚¹å‡»æŒ‰é’®å¼€å§‹è¯†åˆ«</p>`;

        // éšè—å½•éŸ³åˆ—è¡¨
        document.getElementById("recordingsList").classList.add("d-none");
      }

      // é¡µé¢åŠ è½½å®Œæˆåæ£€æŸ¥ç³»ç»ŸçŠ¶æ€
      document.addEventListener("DOMContentLoaded", function () {
        fetch("/api/voice/status")
          .then((response) => response.json())
          .then((data) => {
            updateSystemStatus(data.ready);
          })
          .catch((error) => {
            console.error("è·å–ç³»ç»ŸçŠ¶æ€å¤±è´¥:", error);
            updateSystemStatus(false, "æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨");
          });
      });
    </script>
  </body>
</html>
